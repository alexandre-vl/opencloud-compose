services:
  opencloud:
    image: ${OC_DOCKER_IMAGE:-opencloudeu/opencloud-rolling}:${OC_DOCKER_TAG:-latest}
    container_name: opencloud
    user: ${OC_CONTAINER_UID_GID:-1000:1000}
    # IMPORTANT: Load the .env file so Keycloak settings are applied
    env_file:
      - .env
    networks:
      - opencloud-net
      - dokploy-network
    expose:
      - 9200
      - 9205
    entrypoint:
      - /bin/sh
    command:
      - -c
      - opencloud init || true; opencloud server
    environment:
      # Networking
      PROXY_HTTP_ADDR: 0.0.0.0:9200
      PROXY_DEBUG_ADDR: 0.0.0.0:9205
      OC_URL: https://${OC_DOMAIN:-cloud.opencloud.test}
      
      # Logging
      OC_LOG_LEVEL: ${LOG_LEVEL:-info}
      OC_LOG_COLOR: ${LOG_PRETTY:-false}
      OC_LOG_PRETTY: ${LOG_PRETTY:-false}
      
      # Services & Security
      OC_ADD_RUN_SERVICES: ${START_ADDITIONAL_SERVICES}
      PROXY_TLS: "false"
      OC_INSECURE: ${INSECURE:-false}
      
      # SMTP / Notifications
      NOTIFICATIONS_SMTP_HOST: ${SMTP_HOST}
      NOTIFICATIONS_SMTP_PORT: ${SMTP_PORT}
      NOTIFICATIONS_SMTP_SENDER: ${SMTP_SENDER:-OpenCloud Notifications <notifications@cloud.opencloud.test>}
      NOTIFICATIONS_SMTP_USERNAME: ${SMTP_USERNAME}
      NOTIFICATIONS_SMTP_PASSWORD: ${SMTP_PASSWORD}
      NOTIFICATIONS_SMTP_INSECURE: ${SMTP_INSECURE:-false}
      NOTIFICATIONS_SMTP_AUTHENTICATION: ${SMTP_AUTHENTICATION}
      NOTIFICATIONS_SMTP_ENCRYPTION: ${SMTP_TRANSPORT_ENCRYPTION:-none}
      
      # Feature Flags
      FRONTEND_CHECK_FOR_UPDATES: ${CHECK_FOR_UPDATES:-true}
      OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD: ${OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD:-true}
      
      # Collaboration & Tika
      COLLABORA_DOMAIN: ${COLLABORA_DOMAIN:-collabora.opencloud.test}
      SEARCH_EXTRACTOR_TYPE: tika
      SEARCH_EXTRACTOR_TIKA_TIKA_URL: http://tika:9998
      FRONTEND_FULL_TEXT_SEARCH_ENABLED: "true"
      
      # Antivirus
      POSTPROCESSING_STEPS: virusscan
      ANTIVIRUS_MAX_SCAN_SIZE: ${ANTIVIRUS_MAX_SCAN_SIZE:-100MB}
      ANTIVIRUS_INFECTED_FILE_HANDLING: abort
      ANTIVIRUS_SCANNER_TYPE: clamav
      ANTIVIRUS_CLAMAV_SOCKET: /var/run/clamav/clamd.sock
    volumes:
      - ../files/config/opencloud/csp.yaml:/etc/opencloud/csp.yaml
      - ../files/config/opencloud/banned-password-list.txt:/etc/opencloud/banned-password-list.txt
      - ${OC_CONFIG_DIR:-opencloud-config}:/etc/opencloud
      - ${OC_DATA_DIR:-opencloud-data}:/var/lib/opencloud
      - ${OC_APPS_DIR:-./config/opencloud/apps}:/var/lib/opencloud/web/assets/apps
      - ../files/config/opencloud/proxy.yaml:/etc/opencloud/proxy.yaml
      - clamav-socket:/var/run/clamav
    logging:
      driver: ${LOG_DRIVER:-local}
    restart: always
    labels:
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.storage-opencloud-ix8ggs-117-web.rule=Host(`cloud.alexvl.fr`)
      - traefik.http.routers.storage-opencloud-ix8ggs-117-web.entrypoints=web
      # FIXED: Changed from 443 to 9200 to match PROXY_HTTP_ADDR
      - traefik.http.services.storage-opencloud-ix8ggs-117-web.loadbalancer.server.port=9200
      - traefik.http.routers.storage-opencloud-ix8ggs-117-web.service=storage-opencloud-ix8ggs-117-web
      - traefik.enable=true

  collaboration:
    image: ${OC_DOCKER_IMAGE:-opencloudeu/opencloud-rolling}:${OC_DOCKER_TAG:-latest}
    container_name: collaboration
    user: ${OC_CONTAINER_UID_GID:-1000:1000}
    env_file:
      - .env
    networks:
      - opencloud-net
      - dokploy-network
    expose:
      - 9300
    depends_on:
      opencloud:
        condition: service_started
      collabora:
        condition: service_healthy
    entrypoint:
      - /bin/sh
    command:
      - -c
      - opencloud collaboration server
    environment:
      COLLABORATION_GRPC_ADDR: 0.0.0.0:9301
      COLLABORATION_HTTP_ADDR: 0.0.0.0:9300
      MICRO_REGISTRY: nats-js-kv
      MICRO_REGISTRY_ADDRESS: opencloud:9233
      COLLABORATION_WOPI_SRC: https://${WOPISERVER_DOMAIN:-wopiserver.opencloud.test}
      COLLABORATION_APP_NAME: CollaboraOnline
      COLLABORATION_APP_PRODUCT: Collabora
      COLLABORATION_APP_ADDR: https://${COLLABORA_DOMAIN:-collabora.opencloud.test}
      COLLABORATION_APP_ICON: https://${COLLABORA_DOMAIN:-collabora.opencloud.test}/favicon.ico
      COLLABORATION_APP_INSECURE: ${INSECURE:-true}
      COLLABORATION_CS3API_DATAGATEWAY_INSECURE: ${INSECURE:-true}
      COLLABORATION_LOG_LEVEL: ${LOG_LEVEL:-info}
      OC_URL: https://${OC_DOMAIN:-cloud.opencloud.test}
    volumes:
      - ${OC_CONFIG_DIR:-opencloud-config}:/etc/opencloud
    logging:
      driver: ${LOG_DRIVER:-local}
    restart: always

  collabora:
    image: collabora/code:25.04.7.1.1
    container_name: collabora
    networks:
      - opencloud-net
      - dokploy-network
    expose:
      - 9980
    environment:
      aliasgroup1: https://${WOPISERVER_DOMAIN:-wopiserver.opencloud.test}
      DONT_GEN_SSL_CERT: YES
      extra_params: |
        --o:ssl.enable=${COLLABORA_SSL_ENABLE:-true} \
        --o:ssl.ssl_verification=${COLLABORA_SSL_VERIFICATION:-true} \
        --o:ssl.termination=true \
        --o:welcome.enable=false \
        --o:net.frame_ancestors=${OC_DOMAIN:-cloud.opencloud.test} \
        --o:net.lok_allow.host[14]=${OC_DOMAIN:-cloud.opencloud.test} \
        --o:home_mode.enable=${COLLABORA_HOME_MODE:-false}
      username: ${COLLABORA_ADMIN_USER:-admin}
      password: ${COLLABORA_ADMIN_PASSWORD:-admin}
    cap_add:
      - MKNOD
    volumes:
      - /usr/share/fonts/truetype:/usr/share/fonts/truetype/more:ro
      - /usr/share/fonts/truetype:/opt/cool/systemplate/usr/share/fonts/truetype/more:ro
    logging:
      driver: ${LOG_DRIVER:-local}
    restart: always
    entrypoint:
      - /bin/bash
      - -c
    command:
      - coolconfig generate-proof-key && /start-collabora-online.sh
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:9980/hosting/discovery
      interval: 15s
      timeout: 10s
      retries: 5

  tika:
    image: ${TIKA_IMAGE:-apache/tika:latest}
    container_name: tika
    networks:
      - opencloud-net
    restart: always
    logging:
      driver: ${LOG_DRIVER:-local}

  radicale:
    image: ${RADICALE_DOCKER_IMAGE:-opencloudeu/radicale}:${RADICALE_DOCKER_TAG:-latest}
    container_name: radicale
    user: ${OC_CONTAINER_UID_GID:-1000:1000}
    networks:
      - opencloud-net
      - dokploy-network
    expose:
      - 5232
    logging:
      driver: ${LOG_DRIVER:-local}
    restart: always
    volumes:
      - ../files/config/radicale/config:/etc/radicale/config
      - ${RADICALE_DATA_DIR:-radicale-data}:/var/lib/radicale

  clamav:
    image: clamav/clamav:${CLAMAV_DOCKER_TAG:-latest}
    container_name: clamav
    environment:
      CLAMD_CONF_StreamMaxLength: 100M
    networks:
      - opencloud-net
    volumes:
      - clamav-socket:/tmp
      - clamav-db:/var/lib/clamav
    logging:
      driver: ${LOG_DRIVER:-local}
    restart: always

volumes:
  opencloud-config: null
  opencloud-data: null
  radicale-data: null
  clamav-db: null
  clamav-socket: null

networks:
  opencloud-net: null
  dokploy-network:
    external: true
